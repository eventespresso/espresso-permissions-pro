<?php
/*
Plugin Name: Event Espresso - Roles and Permissions Pro
Plugin URI: http://www.eventespresso.com
Description: Provides support for allowing members of the espreesso_event_admin and espreesso_event_manager roles to administer events.
Version: 2.0.2
Author: Seth Shoultes
Author URI: http://www.eventespresso.com
Copyright 2011  Seth Shoultes  (email : seth@eventespresso.com)

Event Espresso 3.1 Software License Agreement

This Software License Agreement (this "Agreement") is between you (either an individual or an entity, referred to hereinafter as "you" or "your") and Event Espresso, LLC, and its affiliates ("Event Espresso, LLC", "we", "our" or "us") for the Event Espresso software that accompanies this Agreement, as may be updated or replaced by feature enhancements, software updates or maintenance releases (the "Software") and any services that may be provided by Event Espresso, LLC under this Agreement ("Services"). Do not use the Software until you have carefully read the following Agreement.

By installing, copying, accessing, downloading or using the Software (or authorizing any other person to do so) you are indicating that you are 18 years of age or older (any parent or guardian of a person under the age of 18 may accept this Agreement on behalf of a user), are capable of entering into a binding legal agreement, have read and understand this Agreement and you accept its terms and conditions. If you do not agree with the terms and conditions of this Agreement, do not install, copy, access, download or use the Software.

1. Grant of License

Subject to the terms and conditions of this Agreement, Event Espresso, LLC grants to you a limited, non-exclusive, worldwide license to install, download and use a single instance of the Software on a single website server ("License") through a single installation. Each License may run one instance of the Software on one domain. Any modification of the Software intended to circumvent the foregoing is prohibited and will result in revocation of the License.

If you are the original licensee of the Software, you may make a one-time, permanent transfer of your license rights in the Software to a third party ("Subsequent Licensee") provided that five (5) conditions are met. The conditions are: (a) you are the original licensee, (b) the Software was purchased by you more than 90 days prior to the transfer, (c) you do not keep a copy of the Software for yourself, (d) the Subsequent Licensee agrees to the terms of this Agreement and the License, and (e) the Subsequent Licensee agrees to assume your license rights in the Software, excluding this transfer right. For sake of clarity, the right to transfer the Software belongs solely to the original licensee; the Subsequent Licensee is prohibited from transferring its rights to any third party. You must disclose the domain where you are using (or plan to use) the License, which may be disclosed in the Event Espresso registered members area. You may set up one additional temporary test forum for the purpose of testing code, template and database modifications. Such a test forum must be password protected, and not made available to the general public at any time.

For purposes of this Agreement, "Software" includes (and the terms and conditions of this Agreement will apply to) any updates, updated or replacement features enhancements, bug fixes or modified versions (collectively, "Update"). "Update" means a release of the Software which adds minor functionality enhancements to the current version. This class of release is identified by the change of the version number to the right of the decimal point, i.e. 4.1 to 4.2. Notwithstanding any other provision of this Agreement, you have no License or right to use any such Update unless, at the time of acquiring such Update, you already hold a valid License to the original Software and have paid any applicable fee for the Update.

2. Restrictions

You may not give copies to another person, or duplicate the Software by any other means, including electronic transmission. You may make one copy of the Software in machine-readable form for backup purposes only; provided that the backup copy must include all copyright or other proprietary notices contained on the original. You may not rent, sublicense, assign, lease, loan, resell for profit, distribute, publish or network the Software or related materials or create derivative works based upon the Software or any part thereof.

You may not use the Software to engage in or allow others to engage in any illegal activity where the Software is accessed and used. You may not use the Software to engage in any activity that will violate the rights of third parties, including, without limitation, through the use, public display, public performance, reproduction, distribution, or modification of communications or materials that infringe copyrights, trademarks, publicity rights, privacy rights, other proprietary rights, or rights against defamation of third parties.

3. Ownership Rights

The Software is licensed to you by Event Espresso, LLC for use only under the terms and conditions of the License. Event Espresso, LLC reserves all rights not granted to you. The Software in its entirety is protected by U.S. and international copyright laws and treaty provisions. Event Espresso, LLC owns and retains all right, title and interest in and to the Software, including all copyrights, patents, trade secret rights, trademarks, service marks and other intellectual property rights therein. Your possession, installation, or use of the Software does not transfer to you any title to the intellectual property in the Software, and you will not acquire any rights to the Software except as expressly set forth in this Agreement. All copies of the Software made hereunder must contain the same proprietary notices that appear on and in the Software, including all Software copyright notices embedded in any design template which must remain unaltered from the original and visible at all times. Event Espresso is a registered trademark of Event Espresso, LLC in the U.S. and in the U.K.

4. Termination

The License for the Software is effective until terminated. You may terminate the License at any time by uninstalling the Software and destroying all copies of the Software in any media. This Agreement may be terminated by Event Espresso, LLC immediately and without notice if you fail to comply with any term or condition of the License or this Agreement. Upon such termination, you must immediately cease using the Software, and destroy all complete and partial copies of the Software.

Leased-License Holders Only. For leased-license holders of any previous version of Event Espresso software, up to and including version 3.0, the License terminates on the last day of your current leased-license agreement with Jelsoft. You may, however, purchase the Software prior to such end date, in which case the License will continue as specified in the first paragraph of this Section 4. Use of the Software after that end date without purchase makes the License void and you must immediately cease using the Software, and destroy all complete and partial copies of the Software.

Event Espresso, LLC reserves the right to change or add to the terms of this Agreement at any time (including but not limited to Internet-based Services, pricing, technical support options, and other product-related policies), and to change, discontinue or impose conditions on any feature or aspect of the Software, or any Internet-based Services provided to you or made available to you through use of the Software. Such changes will be effective upon notification by any means reasonable to give you actual or constructive notice including by posting such terms on the EventEspresso.com website, or another website designated by Event Espresso, LLC. Your continued use of the Software will indicate your agreement to any such change.

5. Registration Data

You must register to use the Software and Services and (a) provide true, accurate, current and complete information as prompted by the sign-up process (the "Registration Data"), and (b) maintain and promptly update the Registration Data to keep it accurate, current and complete. If you provide any Registration Data that is inaccurate, not current or incomplete, or we have reasonable grounds to suspect is inaccurate, not current or incomplete, we may suspend or terminate your account unless and until such data is corrected or completed, or we may refuse any and all current or future access to and use of the Software or Services (or any portion thereof).

6. Account Access Information and Data

You are solely responsible for (a) maintaining the confidentiality and security of your access number(s), password(s), security question(s) and answer(s), account number(s), login information, and any other security or access information, used by you to access the Software and Services (collectively, "Access Information"), and (b) preventing unauthorized access to or use of the information, files or data that you store or use in or with the Software and Services (collectively, "Account Data"). We will assume that any communications we receive through use of the Access Information were sent or authorized by you.

7. Fees and Payments

We reserve the right to charge fees for future Services in our sole discretion. If we decide to charge for the Services, such charges will be disclosed to you prior to our charging for them.

8. Feedback

We may provide you with a mechanism to provide feedback, suggestions and ideas about the Software. You agree that we may use the feedback you provide in any way, including in future modifications of the Software. You grant us a perpetual, worldwide, fully transferable, non-revocable, royalty free license to use, modify, create derivative works from, distribute and display any information you provide to us in the feedback.

9. DISCLAIMER OF WARRANTIES

THE SOFTWARE IS PROVIDED "AS-IS," AND TO THE MAXIMUM EXTENT PERMITTED BY APPLICABLE LAW, EVENT ESPRESSO, LLC DISCLAIMS ALL OTHER WARRANTIES, EXPRESS OR IMPLIED, BY STATUTE OR OTHERWISE, REGARDING THE SOFTWARE AND ANY RELATED MATERIALS, INCLUDING THEIR FITNESS FOR A PARTICULAR PURPOSE, THEIR QUALITY, THEIR MERCHANTABILITY, OR THEIR NONINFRINGEMENT. EVENT ESPRESSO, LLC DOES NOT WARRANT THAT THE SOFTWARE OR ANY RELATED SERVICES OR CONTENT IS SECURE, OR IS FREE FROM BUGS, VIRUSES, ERRORS, OR OTHER PROGRAM LIMITATIONS NOR DOES IT WARRANT ACCESS TO THE INTERNET OR TO ANY OTHER SERVICE THROUGH THE SOFTWARE. SOME JURISDICTIONS DO NOT ALLOW THE EXCLUSION OF IMPLIED WARRANTIES, SO THE ABOVE EXCLUSIONS MAY NOT APPLY TO YOU. IN THAT EVENT, ANY IMPLIED WARRANTIES ARE LIMITED IN DURATION TO 30 DAYS FROM THE DATE OF PURCHASE OF THE SOFTWARE. THIS WARRANTY GIVES YOU SPECIFIC LEGAL RIGHTS. YOU MAY HAVE OTHER RIGHTS, WHICH VARY FROM JURISDICTION TO JURISDICTION. THE ENTIRE RISK AS TO THE RESULTS, QUALITY AND PERFORMANCE OF THE SOFTWARE IS WITH YOU.

10. LIMITATION OF LIABILITY

TO THE MAXIMUM EXTENT PERMITTED BY APPLICABLE LAW, EVENT ESPRESSO, LLC AND ITS AFFILIATES WILL NOT BE LIABLE FOR ANY INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES (INCLUDING DAMAGES FOR LOSS OF BUSINESS, LOSS OF PROFITS, OR THE LIKE), WHETHER BASED ON BREACH OF CONTRACT, TORT (INCLUDING NEGLIGENCE), PRODUCT LIABILITY OR OTHERWISE, EVEN IF EVENT ESPRESSO, LLC OR ITS REPRESENTATIVES OR AFFILIATES HAVE BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES AND EVEN IF A REMEDY SET FORTH HEREIN IS FOUND TO HAVE FAILED OF ITS ESSENTIAL PURPOSE. EVENT ESPRESSO, LLC’ TOTAL LIABILITY TO YOU FOR ACTUAL DAMAGES FOR ANY CAUSE WHATSOEVER WILL BE LIMITED TO THE PURCHASE PRICE AMOUNT PAID BY YOU FOR THE SOFTWARE. SOME JURISDICTIONS DO NOT ALLOW THE LIMITATION OR EXCLUSION OF LIABILITY FOR INCIDENTAL OR CONSEQUENTIAL DAMAGES, SO THE ABOVE LIMITATION OR EXCLUSION MAY NOT APPLY TO YOU. THE LIMITATIONS OF THE DAMAGES SET FORTH HEREIN ARE FUNDAMENTAL ELEMENTS OF THE BASIS OF THE BARGAIN BETWEEN EVENT ESPRESSO, LLC AND YOU; EVENT ESPRESSO, LLC WOULD NOT HAVE BEEN ABLE TO PROVIDE THE SOFTWARE TO YOU WITHOUT SUCH LIMITATIONS.

11. Indemnification

You agree to defend, indemnify and hold Event Espresso, LLC and our officers, directors, employees, agents or affiliates, harmless from and against any and all claims, losses, liability costs and expenses (including but not limited to attorneys' fees) arising from your use of the Software or your Event Espresso forum users' use of the Software, laws or regulations, or any third party's rights, including but not limited to infringement of any copyright, violation of any proprietary right or invasion of any privacy rights. This obligation will survive the termination of this Agreement.

12. U.S. Government End Users

The Software and any related documentation are "Commercial Items", as that term is defined at 48 C.F.R. §2.101, consisting of "Commercial Computer Software" and "Commercial Computer Software Documentation", as such terms are used in 48 C.F.R. §12.212 or 48 C.F.R. §227.7202, as applicable. Consistent with 48 C.F.R. §12.212 or 48 C.F.R. §227.7202-1 through 227.7202-4, as applicable, the Commercial Computer Software and Commercial Computer Software Documentation are being licensed to U.S. Government end users (a) only as Commercial Items, and (b) with only those rights as are granted to all other end users pursuant to the terms and conditions herein. Unpublished-rights are reserved under the copyright laws of the United States.

13. Export Control

The manufacture and sale of the Software is subject to the export control laws of the United States. You may not use or otherwise export or re-export the Software except as authorized by United States law and the laws of the jurisdiction in which the Software was purchased. In particular, but without limitation, the Software may not be exported or re-exported (a) into any U.S. embargoed countries, or (b) to anyone on the U.S. Treasury Department's list of Specially Designated Nationals or the U.S. Department of Commerce Denied Person’s List or Entity List. By using the Software, you represent and warrant that you are not located in any such country or jurisdiction, or on any such list. You also agree that you will not use these products for any purposes prohibited by United States law or the law of the jurisdiction in which the Software was purchased, including, without limitation, the development, design, manufacture or production of missiles, or nuclear, chemical or biological weapons.

14. Controlling Law; Severability

The License and this Agreement are governed by and construed in accordance with the laws of the State of California, United States of America. You hereby consent to the exclusive jurisdiction and venue in the state and federal courts of the County of Los Angeles, California and the Central District of California, respectively. The License will not be governed by the United Nations Convention on Contracts for the International Sale of Goods, the application of which is expressly excluded. If for any reason a court of competent jurisdiction finds any provision, or portion thereof, to be unenforceable, the remainder of the License will continue in full force and effect. Unless otherwise required by law, an action or proceeding by you to enforce an obligation, duty, or right arising under the License or this Agreement or by law with respect to the Software or Services must be commenced within one (1) year after the cause of action accrues.

15. Refund Policy for Purchases of Event Espresso Products

No refunds will be offered for the Software once it has been downloaded. No refunds will be offered for the purchase of other Event Espresso products.

16. Miscellaneous

You acknowledge that, in providing you with the Software and/or Services, Event Espresso, LLC has relied upon your agreement to be bound by the terms of this Agreement. You further acknowledge that you have read, understood, and agreed to be bound by the terms of the License and this Agreement, and hereby reaffirm your acceptance of those terms. You further acknowledge that this Agreement constitutes the complete statement of the agreement between you and Event Espresso, LLC, and that this Agreement does not include any other prior or contemporaneous promises, representations, or descriptions regarding the Software. The unauthorized agents, employees or distributors of Event Espresso, LLC or its affiliates are not authorized to make modifications to this Agreement, or to make any additional representations, commitments, or warranties binding on Event Espresso, LLC. Accordingly, additional statements, whether oral or written, do not constitute representations or warranties by Event Espresso, LLC and should not be relied upon.

Revised: 05/11/2011



*/
//Define the version of the plugin
function espresso_manager_pro_version() {
	return '2.0.1';
}
define("ESPRESSO_MANAGER_VERSION", espresso_manager_pro_version() );

//Define the plugin directory and path
define("ESPRESSO_MANAGER_PLUGINPATH", "/" . plugin_basename( dirname(__FILE__) ) . "/");
define("ESPRESSO_MANAGER_PLUGINFULLPATH", WP_PLUGIN_DIR . ESPRESSO_MANAGER_PLUGINPATH  );
define("ESPRESSO_MANAGER_PLUGINFULLURL", WP_PLUGIN_URL . ESPRESSO_MANAGER_PLUGINPATH );

//Globals
global $espresso_manager;
$espresso_manager = get_option('espresso_manager_settings');

//Install the plugin
function espresso_manager_pro_install(){
	// add more capabilities
	
	//Regional Manager role
	$result = add_role('espresso_group_admin', 'Espresso Regional Manager', array(
	    'read' => true, // True allows that capability
	    'edit_posts' => false,
	    'espresso_group_admin' => true,
	    'espresso_event_admin' => true,
	    'espresso_event_manager' => true,
	    'delete_posts' => false, // Use false to explicitly deny
	));
	
	//Event Manager role
	$result = add_role('espresso_event_manager', 'Espresso Event Manager', array(
	    'read' => true, // True allows that capability
	    'edit_posts' => false,
	    'espresso_group_admin' => false,
	    'espresso_event_admin' => false,
	    'espresso_event_manager' => true,
	    'delete_posts' => false, // Use false to explicitly deny
	));
}
register_activation_hook(__FILE__,'espresso_manager_pro_install');

//Checks to see if a user has permissions to view an event.
function espresso_can_view_event($event_id){
   if( espresso_member_data('role')=='espresso_group_admin' ){
       if( espresso_do_i_manage($event_id) ){
           return true;
       }
   }else{
       if ( current_user_can('espresso_event_admin')==true || espresso_is_my_event($event_id) ){
           return true;
       }
   }
}

//Checks to see if a user is an admin
function espresso_is_admin(){
	if( espresso_member_data('role')=='espresso_group_admin' || espresso_member_data('role')=='espresso_event_admin' || current_user_can('administrator') ){
		return true;
	}
}

//Checks to see if this is the users event
function espresso_is_my_event($event_id){
  global $wpdb;
  if( current_user_can('administrator') || espresso_member_data('role')=='espresso_event_admin'){
      return true;
  }elseif( espresso_member_data('role')=='espresso_group_admin' ){
      return ( espresso_do_i_manage($event_id) ? true : false);
  }else{
      $sql = "SELECT e.wp_user ";
      $sql .= " FROM ". EVENTS_DETAIL_TABLE ." e ";
      $sql .= " WHERE e.id = '$event_id' ";
      $wpdb->get_results($sql);
      if ($wpdb->num_rows >0)  return (espresso_member_data('id') == $wpdb->last_result[0]->wp_user ? true : false);
  }
}

function espresso_do_i_manage($event_id){
	global $wpdb, $org_options,$current_user;
	wp_get_current_user();
	$group = get_user_meta(espresso_member_data('id'), "espresso_group", true);
	$group = unserialize($group);
	if( espresso_member_data('role')=='espresso_group_admin' ){
		$sql = "(SELECT e.wp_user ";
		$sql .= " FROM ". EVENTS_DETAIL_TABLE ." e ";
		if ($group !=''){
			$sql .= " JOIN " . EVENTS_VENUE_REL_TABLE . " r ON r.event_id = e.id ";
			$sql .= " JOIN " . EVENTS_LOCALE_REL_TABLE . " l ON  l.venue_id = r.venue_id ";
		}
		$sql .= " WHERE  e.id = '$event_id'";
		$sql .= $group !='' ? " AND l.locale_id IN (" . implode(",",$group) . ") " : '';
		$sql .= ") UNION (";
		$sql .= "SELECT e.wp_user ";
		$sql .= " FROM ". EVENTS_DETAIL_TABLE ." e ";
		$sql .= " WHERE  e.id = '$event_id'";
		$sql .= " AND wp_user = '" . espresso_member_data('id') ."'";
		$sql .= ")";
		$wpdb->get_results($sql);
		if ($wpdb->num_rows >0)	return $wpdb->last_result[0]->wp_user;
	}
}

//Returns information about the current roles
function espresso_role_data($type){
	global $wpdb;
	$sql = "SELECT
    ID, user_email, user_login,
    first_name.meta_value as first_name,
    last_name.meta_value as last_name,
    phone_number.meta_value as phone_number,
    wp_capabilities.meta_value as wp_capabilities ";
	$sql .= " FROM wp_users
		JOIN wp_usermeta AS wp_capabilities ON wp_capabilities.user_id=ID
			AND wp_capabilities.meta_key='wp_capabilities'
		LEFT JOIN wp_usermeta AS first_name ON first_name.user_id=ID
			AND first_name.meta_key='first_name'
		LEFT JOIN wp_usermeta AS last_name ON last_name.user_id=ID
			AND last_name.meta_key='last_name'
		LEFT JOIN wp_usermeta AS phone_number ON phone_number.user_id=ID
			AND phone_number.meta_key='phone_number' ";
	$sql .= " WHERE ";
	//$sql .= " wp_capabilities.meta_value LIKE '%administrator%' OR wp_capabilities.meta_value LIKE '%espresso_event_admin%' OR wp_capabilities.meta_value LIKE '%espresso_event_manager%' ";
	//$sql .= " ORDER BY ID";

	switch($type){
		case 'admin_count':
			$sql .= " wp_capabilities.meta_value LIKE '%administrator%' ";
			$wpdb->get_results($sql);
			return $wpdb->num_rows;
		break;
		case 'event_manager_count':
			$sql .= " wp_capabilities.meta_value LIKE '%espresso_event_manager%' ";
			$wpdb->get_results($sql);
			return $wpdb->num_rows;
		break;
		case 'event_admin_count':
			$sql .= " wp_capabilities.meta_value LIKE '%espresso_event_admin%' ";
			$wpdb->get_results($sql);
			return $wpdb->num_rows;
		case 'event_group_count':
			$sql .= " wp_capabilities.meta_value LIKE '%espresso_group_admin%' ";
			$wpdb->get_results($sql);
			return $wpdb->num_rows;
		break;
	}
}

function espresso_manager_pro_options(){
	global $espresso_manager;
	$values=array(
		array('id'=>'N','text'=> __('No','event_espresso')),
		array('id'=>'Y','text'=> __('Yes','event_espresso')),
	);
?>

    <div class="postbox">
      <h3>
        <?php _e('Advanced Options', 'event_espresso'); ?>
      </h3>
      <div class="inside">
        <p>
          <?php _e('Events created by "Event Managers" require approval?', 'event_espresso'); ?>
          <?php echo select_input('event_manager_approval', $values, $espresso_manager['event_manager_approval']);?></p>
        <p>
          <?php _e('Regional managers can edit venues assigned to them?', 'event_espresso'); ?>
          <?php echo select_input('event_manager_venue', $values, $espresso_manager['event_manager_venue']);?></p>
        <p>
          <?php _e('Regional managers are in charge only of their staff?', 'event_espresso'); ?>
          <?php echo select_input('event_manager_staff', $values, $espresso_manager['event_manager_staff']);?></p>
        <p>
          <?php _e('Anyone can create a post when publishing an event?', 'event_espresso'); ?>
          <?php echo select_input('event_manager_create_post', $values, $espresso_manager['event_manager_create_post']);?></p>
        <p>
          <?php _e('Enable sharing of categories between users?', 'event_espresso'); ?>
          <?php echo select_input('event_manager_share_cats', $values, $espresso_manager['event_manager_share_cats']);?></p>
      </div>
    </div>
<?php
}